<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart Control WebApp</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f2f2f2;
    }
    .device {
      background: white;
      padding: 15px;
      margin: 15px 0;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .device label {
      display: block;
      margin: 10px 0 5px;
    }
    button, select, input[type="text"] {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
    }
    .toggle {
      margin: 5px 0;
    }
  </style>
</head>
<body>

  <h2>Add Device</h2>
  <div class="device">
    <label>Device Name:</label>
    <input type="text" id="deviceName">

    <label>Device ID:</label>
    <input type="text" id="deviceID">

    <label>Device Type:</label>
    <select id="deviceType">
      <option value="alarm">Alarm Module</option>
      <option value="plug">Multi Plug</option>
      <option value="bot">Smart Bot</option>
    </select>

    <button onclick="addDevice()">Add Device</button>
  </div>

  <h2>My Devices</h2>
  <div id="deviceList"></div>

  <script>
    function addDevice() {
      const name = document.getElementById('deviceName').value.trim();
      const id = document.getElementById('deviceID').value.trim();
      const type = document.getElementById('deviceType').value;

      if (!name || !id) {
        alert("Name and ID are required!");
        return;
      }

      let devices = JSON.parse(localStorage.getItem("devices") || "[]");

      if (devices.find(d => d.id === id)) {
        alert("Device with this ID already exists!");
        return;
      }

      devices.push({ name, id, type });
      localStorage.setItem("devices", JSON.stringify(devices));

      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.sendData(`/register ${id}`);
      }

      renderDevices();
    }

    function renderDevices() {
      const list = document.getElementById('deviceList');
      list.innerHTML = '';

      const devices = JSON.parse(localStorage.getItem("devices") || "[]");

      devices.forEach(device => {
        const wrapper = document.createElement('div');
        wrapper.className = 'device';

        const title = document.createElement('h3');
        title.textContent = device.name;
        wrapper.appendChild(title);

        if (device.type === 'alarm') {
          const btn = document.createElement('button');
          btn.textContent = 'Trigger Alarm';
          btn.onclick = () => sendCommand(device.id, 'trigger');
          wrapper.appendChild(btn);

        } else if (device.type === 'plug') {
          for (let i = 1; i <= 3; i++) {
            const toggle = document.createElement('div');
            toggle.className = 'toggle';

            const label = document.createElement('label');
            label.textContent = `Plug ${i}`;

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.onchange = () => sendCommand(device.id, `plug${i}:${input.checked ? 'on' : 'off'}`);

            toggle.appendChild(label);
            toggle.appendChild(input);
            wrapper.appendChild(toggle);
          }

        } else if (device.type === 'bot') {
          for (let i = 1; i <= 4; i++) {
            const label = document.createElement('label');
            label.textContent
