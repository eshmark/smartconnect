WiFiClientSecure client;

const int switchPin = 0;  // GPIO0
bool switchState = LOW;
unsigned long lastPoll = 0;

void setup() {
  Serial.begin(115200);
  pinMode(switchPin, INPUT_PULLUP);

  WiFi.begin(ssid, password);
  client.setInsecure();  // Skip certificate check

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi connected");
  sendTelegramMessage("ESP-01S connected to WiFi.");
}

void loop() {
  bool currentState = digitalRead(switchPin) == LOW;  // Active LOW
  if (currentState && !switchState) {
    sendTelegramMessage("Connector Switch ON");
  }

  switchState = currentState;

  if (switchState && millis() - lastPoll >= 2000) {
    checkTelegramCommands();
    lastPoll = millis();
  }
}

void sendTelegramMessage(const String& message) {
  if (client.connect("api.telegram.org", 443)) {
    String url = "/bot" + String(botToken) + "/sendMessage?chat_id=" + chatId + "&text=" + message;
    client.print(String("GET ") + url + " HTTP/1.1\r\n" +
                 "Host: api.telegram.org\r\n" +
                 "Connection: close\r\n\r\n");
    delay(500);
    while (client.available()) client.read();  // Clear response
    client.stop();
  }
}

void checkTelegramCommands() {
  if (!client.connect("api.telegram.org", 443)) return;

  String url = "/bot" + String(botToken) + "/getUpdates?timeout=5";
  client.print(String("GET ") + url + " HTTP/1.1\r\n" +
               "Host: api.telegram.org\r\n" +
               "Connection: close\r\n\r\n");

  String payload;
  while (client.connected() || client.available()) {
    if (client.available()) {
      payload += client.readStringUntil('\n');
    }
  }

  client.stop();

  DynamicJsonDocument doc(2048);
  DeserializationError error = deserializeJson(doc, payload);
  if (error) return;

  JsonArray results = doc["result"];
  for (JsonObject update : results) {
    String text = update["message"]["text"] | "";
    if (text.indexOf(deviceId) != -1 && text.indexOf("press on") != -1) {
      sendTelegramMessage("okay done");
    }
  }
}
